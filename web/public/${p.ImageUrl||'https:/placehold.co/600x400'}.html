<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <!-- PWA-like standalone for iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Pangpaan POS">
  <link rel="apple-touch-icon" href="http://127.0.0.1:8888/icons/apple-touch-icon-180.png">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Pangpaan POS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="../../ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <style>
    html,body{height:100%}
    body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#fff;color:#0f172a}
    .pill{--b:rgba(15,23,42,.08); --t:#334155}
    .pill{border:1px solid var(--b);padding:.45rem .8rem;border-radius:999px;font-size:.85rem;white-space:nowrap;color:var(--t);background:#fff}
    .pill.active{background:#111827;color:#fff;border-color:#111827}
    .muted{color:#64748b}
    .card{background:#fff;border:0;border-radius:.75rem;box-shadow:none}
    .btn{border-radius:.6rem;font-weight:700}
    .btn-gray{background:#eef2f7;color:#0f172a}
    .btn-outline{border:1px solid #e5e7eb;background:#fff}
    .btn-green{background:#22c55e;color:#052e16}
    .dbchip{display:inline-block;padding:.15rem .5rem;border-radius:999px;font-size:.75rem;border:1px solid #e5e7eb;background:#fff}
    .qty-btn{width:1.8rem;height:1.8rem;display:inline-grid;place-items:center;border:1px solid #cbd5e1;border-radius:.375rem}
    .product{position:relative;overflow:hidden}
    .product img{width:100%;height:132px;object-fit:cover;border-top-left-radius:.75rem;border-top-right-radius:.75rem}
    @media (min-width:640px){ .product img{ height:160px; } }
    @media (min-width:1024px){ .product img{ height:180px; } }
    .divider{height:0;background:transparent}
    .safe-pad-top{padding-top:constant(safe-area-inset-top);padding-top:env(safe-area-inset-top)}
    :root{--header-h:0px}
    /* Ensure content always clears header + add a small visual gap */
    .has-fixed-header{padding-top: calc(var(--header-h) + 8px)}
    @supports (padding-top: max(0px)) {
      /* Extra safety on iOS when header height changes after bars collapse */
      .has-fixed-header{padding-top: calc(max(var(--header-h), env(safe-area-inset-top)) + 8px);}    
    }
    /* Fallback header/page-content rules (JS will compute exact offset) */
    header{ position:fixed; top:0; left:0; right:0; z-index:50 }
    .page-content{ padding-top:56px }
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:50}
    .modal{background:#fff;border-radius:.75rem;width:min(680px,calc(100vw - 2rem));max-height:90vh;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .receipt{font-size:.9rem}
    .receipt table{width:100%;border-collapse:collapse}
    .receipt thead th{font-size:.75rem;color:#64748b;text-transform:uppercase}
    .receipt td,.receipt th{padding:.4rem .5rem}
    .receipt tr:not(:last-child) td{border-bottom:1px dashed #e5e7eb}
    .no-print{display:block}
    @media print{ header,nav,#dbChip,.no-print{display:none!important} .modal-overlay{position:static;background:#fff} .modal{box-shadow:none;width:100%;max-height:none;border-radius:0} body{background:#fff} }
  /* Standalone-safe area + avoid Safari bars */
  .app{
    min-height: 100svh;
    padding-bottom: env(safe-area-inset-bottom);
    padding-top: env(safe-area-inset-top);
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
  }
  /* Floating Cart Button */
  .fab{position:fixed; right:1rem; bottom:calc(1rem + env(safe-area-inset-bottom)); z-index:40}
  .fab-btn{width:56px; height:56px; border-radius:9999px; background:#22c55e; color:#fff; font-size:1.4rem; display:flex; align-items:center; justify-content:center; border:4px solid #fff; box-shadow:0 10px 20px rgba(0,0,0,.18)}
  .fab-btn:hover{background:#16a34a}
  .fab-badge{position:absolute; top:-6px; right:-6px; min-width:22px; height:22px; padding:0 6px; border-radius:9999px; background:#ef4444; color:#fff; font-size:.75rem; font-weight:700; display:flex; align-items:center; justify-content:center; border:2px solid #fff}
  .fab.hidden{display:none}
  /* Accessible touch targets */
  .touch-btn{min-width:84px; min-height:56px; padding:.9rem 1.1rem; font-size:1.125rem; line-height:1; border-radius:.75rem}
  .touch-btn--ghost{background:#fff; border:2px solid #e5e7eb; color:#0f172a}
  .touch-btn--primary{background:#16a34a; color:#fff; border:4px solid #fff}
  /* Alert dialog */
  #alertDialog{position:fixed; inset:0; display:none; z-index:60;}
  #alertDialog.show{display:flex}
  #alertBackdrop{position:absolute; inset:0; background:rgba(0,0,0,.5)}
  #alertCard{position:relative; margin:auto; width:min(92vw, 520px); background:#fff; border-radius:1rem; box-shadow:0 20px 36px rgba(0,0,0,.25); padding:1.1rem}
  #alertTitle{font-size:1.25rem; font-weight:800; margin-bottom:.25rem}
  #alertMsg{font-size:1.125rem; color:#0f172a}
  </style>
</head>
<body class="min-h-full has-fixed-header app">
  <!-- Top Bar -->
  <header class="bg-black text-white fixed top-0 left-0 right-0 z-20 safe-pad-top" style="will-change:height">
    <div class="mx-auto max-w-7xl px-4 md:px-6 py-3 flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4">
      <div class="text-xl font-extrabold tracking-tight select-none">
        <span class="opacity-90">Pangpaan</span>
        <span class="text-green-400">POS</span>
      </div>
      <!-- Floating DB chip -->
      <div id="dbChip" class="dbchip fixed right-2 top-[calc(var(--header-h)+6px)] bg-red-50 text-red-700 border-red-300">üî¥ DB</div>
      <nav id="topNav" class="sm:ml-auto mt-1 sm:mt-0 flex items-center gap-4 sm:gap-5 md:gap-6 text-xs sm:text-sm md:text-base overflow-x-auto whitespace-nowrap [-webkit-overflow-scrolling:touch]">
        <a href="http://127.0.0.1:8888/pos" class="opacity-90 hover:opacity-100">POS</a>
        <a href="http://127.0.0.1:8888/products" class="opacity-90 hover:opacity-100">Products</a>
        <a href="http://127.0.0.1:8888/sale" class="opacity-90 hover:opacity-100">Sales History</a>
        <a href="http://127.0.0.1:8888/admin" class="opacity-90 hover:opacity-100">Admin</a>
      </nav>
    </div>
  </header>

  <!-- App -->
  <main class="mx-auto max-w-7xl px-4 md:px-6 py-6 page-content" id="app"></main>

<!-- Floating Cart Button -->
<div id="cartFab" class="fab hidden">
  <button id="cartFabBtn" class="fab-btn" aria-label="‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤"><i class="fa-solid fa-cart-shopping" aria-hidden="true"></i></button>
  <span id="cartFabCount" class="fab-badge">0</span>
</div>

<!-- Accessible Alert Dialog (Tailwind utilities) -->
<div id="alertDialog" role="dialog" aria-modal="true" aria-labelledby="alertTitle" class="items-end sm:items-center justify-center p-4">
  <div id="alertBackdrop"></div>
  <div id="alertCard" class="no-print">
    <div id="alertTitle">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
    <div id="alertMsg" class="mt-1">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</div>
    <div class="mt-4 flex gap-2 justify-end">
      <button id="alertCancel" class="touch-btn touch-btn--ghost hidden">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button id="alertOK" class="touch-btn touch-btn--primary">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>
</div>

<script>
function __setHeaderPad(){
  var h=document.querySelector('header');
  if(!h) return;
  var last = 0;
  var apply = function(){
    var hh = h.offsetHeight || 0;
    if(hh !== last){
      last = hh;
  document.documentElement.style.setProperty('--header-h', hh + 'px');
  try{ if(typeof adjustContentOffset==='function') adjustContentOffset(); }catch(e){}
    }
  };
  // apply now and once more on next frame to catch font/safe-area reflow
  apply();
  requestAnimationFrame(apply);
  setTimeout(apply, 200);
}
function adjustContentOffset(){
  const header = document.querySelector('header');
  const content = document.querySelector('.page-content');
  if(!header || !content) return;
  const headerH = header.offsetHeight || 0;
  content.style.paddingTop = headerH + 'px';
}
window.addEventListener('DOMContentLoaded', __setHeaderPad);
window.addEventListener('load', __setHeaderPad);
window.addEventListener('pageshow', __setHeaderPad);
window.addEventListener('resize', __setHeaderPad);
window.addEventListener('orientationchange', __setHeaderPad);
window.addEventListener('visibilitychange', function(){ if(!document.hidden) __setHeaderPad(); });
window.addEventListener('load', adjustContentOffset);
window.addEventListener('resize', adjustContentOffset);
window.addEventListener('orientationchange', adjustContentOffset);
(function(){
  if(location.pathname.replace(/\/+$/,'')==='\/admin'){
    // If /admin was rewritten to index.html (SPA), forward-load admin.html then admin will replaceState back to /admin
    location.replace('/admin.html?from=spa');
    return;
  }
  'use strict';
  const PROMPTPAY_ID='0868938788';
  const LS_PRODUCTS='posProducts';
  const LS_SALES='posSales';

  let products=[];      // master product list
  // show only real items (no mock/empty images)
  const REQUIRE_IMAGE = false;
  const DISABLE_PRODUCT_GRID = false; // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏õ‡∏∏‡πà‡∏° Add
  let order=[];         // cart items [{code,name,price,qty}]
  let activeCat='‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
  let payMethod='cash';
  let discountPct=0;    // %
  function pathToPage(){
    const p=location.pathname.replace(/\/+$/,'');
    if(p==='/sale') return 'history';
    if(p==='/products') return 'products';
    // default: /pos or /
    return 'pos';
  }
  let currentPage=pathToPage();
  let testsRan=false;

  const $=sel=>document.querySelector(sel);
  const app=$('#app');

  // Visible products = onshelf + (has image if REQUIRE_IMAGE)
  function visibleProducts() {
    const hasImg = p => (p.ImageUrl && String(p.ImageUrl).trim() !== '');
    return products
      .filter(p => String(p.onshelf||'').toLowerCase()==='on')
      .filter(p => !REQUIRE_IMAGE || hasImg(p));
  }

  const fmt=n=>Number(n||0).toFixed(2);
  const money=n=>'‡∏ø '+fmt(n);
  function setDbChip(ok){ const el=document.getElementById('dbChip'); if(!el) return; if(ok){ el.textContent='üü¢ DB'; el.className='dbchip fixed right-2 top-[calc(var(--header-h)+6px)] bg-green-50 text-green-700 border-green-300'; } else { el.textContent='üî¥ DB'; el.className='dbchip fixed right-2 top-[calc(var(--header-h)+6px)] bg-red-50 text-red-700 border-red-300'; } }

  async function fetchJSON(url){
    const r = await fetch(url);
    if(!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }

  async function loadProducts(){
    // 1) Try API first
    try{
      const res = await fetch('/api/products');
      if(res.ok){
        setDbChip(true);
        const rows = await res.json();
        products = rows.map(r=>({
          ProductCode: r.product_code,
          Name: r.name,
          Category: r.category || '‡∏≠‡∏∑‡πà‡∏ô‡πÜ',
          Unit: r.unit || '',
          UnitPrice: Number(r.unit_price || 0),
          ImageUrl: r.image_url || '',
          onshelf: r.onshelf ? 'on' : 'off'
        }));
        localStorage.setItem(LS_PRODUCTS, JSON.stringify(products)); // cache for offline
        return;
      }
      setDbChip(false);
    }catch(e){
      setDbChip(false);
      console.warn('loadProducts API failed, fallback to localStorage', e);
    }
    // 2) Fallback to localStorage (no seeding)
    try{
      products = JSON.parse(localStorage.getItem(LS_PRODUCTS)||'[]');
      // Auto-clear old seeded demo products (from POS_2c) if detected
      try{
        const SEEDED=['TAC01','BUR01','BUR02','BUR03','JUI01','JUI02','SAL01','SUS01'];
        const count = Array.isArray(products) ? products.filter(p=>SEEDED.includes(p?.ProductCode)).length : 0;
        if(count>=3){
          localStorage.removeItem(LS_PRODUCTS);
          products = [];
        }
      }catch{}
    }
    catch{ products = []; }
  }
  const saveSales=s=>localStorage.setItem(LS_SALES,JSON.stringify(s));
  const loadSales=()=>{try{return JSON.parse(localStorage.getItem(LS_SALES)||'[]')}catch{return[]}};

  function getCats(){
    const act = visibleProducts();
    const cats = Array.from(new Set(act.map(p=>p.Category))).filter(Boolean);
    return ['‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', ...cats];
  }

  function subtotal(){return order.reduce((s,i)=>s+(i.UnitPrice*i.qty),0)}
  function discountAmt(){return subtotal()*(discountPct/100)}
  function grandTotal(){return Math.max(0, subtotal()-discountAmt())}

  function layoutHTML(){
    return `
    <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
      <!-- Left (content) -->
      <section id="leftCol" class="md:col-span-${(currentPage==='products'||currentPage==='history')?'12':'7'} space-y-3">
        <!-- Categories -->
        <div id="catCard" class="card px-2 py-1 md:p-2">
          <h2 class="font-bold text-base md:text-lg mb-0">Categories</h2>
          <div id="catBar" class="flex flex-wrap gap-1">
            ${getCats().map(c=>`<button class="pill ${c===activeCat?'active':''}" data-cat="${c}">${c}</button>`).join('')}
          </div>
        </div>

        <!-- Products grid -->
        <div id="prodCard" class="card p-4">
          <div class="flex items-center justify-between mb-3">
            <h2 class="font-bold text-lg">Menu</h2>
          </div>
          <div id="productGrid" class="grid grid-cols-2 md:grid-cols-3 gap-3"></div>
        </div>
      </section>

      ${(currentPage==='products'||currentPage==='history') ? '' : `
      <!-- Right (Order Details Sidebar) -->
      <aside class="md:col-span-5">
        <div class="card p-4 md:sticky md:top-20 flex flex-col md:h-[calc(100dvh-120px)]">
          <div class="flex items-center mb-2">
            <h2 class="font-bold text-lg">Order Details</h2>
          </div>
          <div id="cartList" class="space-y-3 md:flex-1 md:overflow-auto pr-1"></div>
          <div class="divider my-4"></div>

          <div class="space-y-2 text-sm mt-auto">
            <div class="flex justify-between"><span class="muted">Subtotal</span><span id="subTotal">0.00</span></div>
            <div class="flex items-center justify-between gap-2">
              <div class="flex items-center gap-2"><span class="muted">Discount</span>
                <input id="discountPct" type="number" min="0" max="100" class="w-16 px-2 py-1 rounded border" value="0">%
              </div>
              <span id="discountAmount">0.00</span>
            </div>
            <div class="divider my-2"></div>
            <div class="flex justify-between items-center text-xl font-extrabold"><span>Total</span><span id="grandTotal">0.00</span></div>
          </div>

          <div class="mt-4">
            <label class="text-sm muted">Payment Method</label>
            <div class="mt-2 flex gap-4">
              <label class="inline-flex items-center gap-2 text-sm"><input type="radio" name="pay" value="cash" checked> Cash</label>
              <label class="inline-flex items-center gap-2 text-sm"><input type="radio" name="pay" value="promptpay"> PromptPay</label>
            </div>
          </div>

          <div id="cashBox" class="mt-3 space-y-2">
            <label class="block text-sm">‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏±‡∏ö‡∏°‡∏≤</label>
            <div class="flex gap-2">
              <input id="cashIn" type="number" inputmode="decimal" placeholder="0.00" class="flex-1 px-3 py-2 rounded border text-right text-slate-900" />
            </div>
            <div class="grid grid-cols-5 gap-1">
              <button class="btn btn-gray px-2 py-2 text-xs" onclick="addCash('clear')">‡∏•‡∏ö</button>
              <button class="btn btn-gray px-2 py-2 text-xs" onclick="addCash('exact')">‡∏û‡∏≠‡∏î‡∏µ</button>
              <button class="btn btn-gray px-2 py-2 text-xs" onclick="addCash(1)">+1</button>
              <button class="btn btn-gray px-2 py-2 text-xs" onclick="addCash(5)">+5</button>
              <button class="btn btn-gray px-2 py-2 text-xs" onclick="addCash(10)">+10</button>
              <button class="btn btn-gray px-2 py-2 text-xs" onclick="addCash(20)">+20</button>
              <button class="btn btn-gray px-2 py-2 text-xs" onclick="addCash(50)">+50</button>
              <button class="btn btn-gray px-2 py-2 text-xs" onclick="addCash(100)">+100</button>
              <button class="btn btn-gray px-2 py-2 text-xs" onclick="addCash(500)">+500</button>
              <button class="btn btn-gray px-2 py-2 text-xs" onclick="addCash(1000)">+1000</button>
            </div>
            <div class="flex justify-between font-semibold"><span>‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô</span><span id="change">0.00</span></div>
          </div>

          <div id="qrBox" class="mt-3 hidden text-center">
            <div id="qrImg" class="inline-block border rounded p-2"></div>
            <div class="mt-2 text-sm font-bold" id="qrSum">0.00 ‡∏ö‡∏≤‡∏ó</div>
          </div>

          <div class="mt-4 flex gap-2">
            <button id="clearBtn" class="btn btn-outline px-3 py-3 flex-1">Clear</button>
            <button id="payBtn" class="btn btn-green px-3 py-3 flex-1 font-extrabold">Pay</button>
          </div>
        </div>
      </aside>
      `}
    </div>`;
  }

  function render(){
    app.innerHTML=layoutHTML();

    // If Sales History page, render table from API and skip POS bindings
    if(currentPage==='history'){
      // Highlight active nav on Sales History
      setActiveNav('history');
      // Bind topNav for SPA navigation while in history page
      const topNav=document.getElementById('topNav');
      if(topNav){
        topNav.addEventListener('click',(e)=>{
          const a=e.target.closest('a'); if(!a) return;
          const href=a.getAttribute('href')||'';
          if(href.startsWith('/admin')) return; // allow normal nav to Admin (separate page)
          if(href.startsWith('/')){ e.preventDefault(); history.pushState({},'',href); applyRoute(); }
        });
      }
      renderSalesHistory();
      return;
    }

    const loc=document.getElementById('locLabel');
    if(loc){
      const p=location.pathname.replace(/\/+$/,'');
      let label='POS';
      if(p==='/products') label='Products';
      else if(p==='/sale') label='Sales History';
      loc.textContent='‚Ä∫ '+label;
    }

    // bind events after mount
    const grid=document.getElementById('productGrid');
    const catBar=document.getElementById('catBar');
    const catClick=e=>{const b=e.target.closest('[data-cat]');if(!b) return;activeCat=b.dataset.cat;render();};
    if(catBar) catBar.addEventListener('click',catClick);

    drawProducts(grid);
    drawCart();

    // Bind refresh button
    const refreshBtn=document.getElementById('refreshBtn');
    if(refreshBtn) refreshBtn.addEventListener('click', ()=>{ refreshProducts(); });
    // Bind reset products button
    const resetBtn=document.getElementById('resetProducts');
    if(resetBtn) resetBtn.addEventListener('click', ()=>{
      if(confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')){
        localStorage.removeItem(LS_PRODUCTS);
        products = [];
        activeCat='‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
        order=[];
        drawProducts(grid);
        drawCart();
      }
    });

    // totals inputs
    const discEl = $('#discountPct'); if(discEl) discEl.addEventListener('input',e=>{discountPct=+e.target.value||0;updateTotals()});

    // payment method
    app.querySelectorAll('input[name="pay"]').forEach(r=>r.addEventListener('change',()=>{
      payMethod=$('input[name="pay"]:checked').value;
      if(payMethod==='cash'){ $('#cashBox').classList.remove('hidden'); $('#qrBox').classList.add('hidden'); }
      else { $('#cashBox').classList.add('hidden'); $('#qrBox').classList.remove('hidden'); updateTotals(); }
    }));

    const cashIn=$('#cashIn');
    if(cashIn) cashIn.addEventListener('input',updateTotals);
    const clearBtnEl=$('#clearBtn'); if(clearBtnEl) clearBtnEl.addEventListener('click',()=>{order=[];drawCart()});
    const payBtnEl=$('#payBtn'); if(payBtnEl) payBtnEl.addEventListener('click',checkout);

    // Intercept topNav navigation for SPA routing
    const topNav=document.getElementById('topNav');
    if(topNav){
      topNav.addEventListener('click',(e)=>{
        const a=e.target.closest('a'); if(!a) return;
        const href=a.getAttribute('href')||'';
        if(href.startsWith('/admin')) return; // allow normal nav to separate page
        if(href.startsWith('/')){ e.preventDefault(); history.pushState({},'',href); applyRoute(); }
      });
    }

    // global search
    const gs=$('#globalSearch');
    if(gs){ gs.oninput=(e)=>{ filterTerm=e.target.value.toLowerCase(); drawProducts(grid); } }

    // show page state
    showPage(currentPage);
    try{ if(typeof updateFab==='function') updateFab(); }catch(e){}

    // run tests once
    if(!testsRan){
      testsRan=true; 
      if(document.getElementById('cashIn')) runTests();
      const ci=$('#cashIn');
      if(ci){ ci.value='0.00'; updateTotals(); }
    
    // Floating FAB -> scroll to Pay button and highlight briefly
    const fabBtn=document.getElementById('cartFabBtn');
    if(fabBtn){
      fabBtn.onclick=()=>{
        const btn=document.getElementById('payBtn');
        if(btn){
          btn.scrollIntoView({behavior:'smooth', block:'center'});
          btn.classList.add('ring-4','ring-green-300');
          setTimeout(()=>btn.classList.remove('ring-4','ring-green-300'), 900);
        }
      };
    }
    try{ if(typeof updateFab==='function') updateFab(); }catch(e){}
    }
  }

  // filtering state
  let filterTerm='';

  function drawProducts(grid){
    // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    if (DISABLE_PRODUCT_GRID) {
      grid.innerHTML = '<div class="col-span-full text-center text-slate-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>';
      return;
    }

    const list = visibleProducts()
        .filter(p=> activeCat==='‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' || p.Category===activeCat)
        .filter(p=> p.Name.toLowerCase().includes(filterTerm));

    if(!list.length){
      grid.innerHTML='<div class="col-span-full text-center text-slate-500 py-8">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</div>';
      return;
    }

    grid.innerHTML=list.map((p)=>`
      <div class="product card group cursor-pointer" data-code="${p.ProductCode}">
        <img src="http://127.0.0.1:8888/$%7Bp.ImageUrl%7C%7C'https://placehold.co/$%7Bp.ImageUrl%7C%7C'https://placehold.co/600x400'%7D" alt="${p.Name}" loading="lazy" decoding="async" fetchpriority="low" referrerpolicy="no-referrer">
        <div class="p-3">
          <div class="text-sm font-semibold line-clamp-2">${p.Name}</div>
          <div class="mt-1 text-lg font-extrabold">${money(p.UnitPrice)}</div>
        </div>
      </div>`).join('');

    grid.querySelectorAll('[data-code]').forEach(card=>{
      card.addEventListener('click',()=>{
        const code=card.getAttribute('data-code');
        const p=products.find(x=>x.ProductCode===code);
        const ex=order.find(x=>x.ProductCode===code);
        if(ex) ex.qty+=1; else order.push({ProductCode:p.ProductCode,Name:p.Name,UnitPrice:p.UnitPrice,qty:1});
        drawCart();
      });
    });
  }

  function drawCart(){
    const wrap=$('#cartList');
    if(!wrap){ updateTotals(); return; }
    wrap.innerHTML='';
    if(!order.length){
      wrap.innerHTML='<div class="text-center text-slate-500 py-6">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>';
      updateTotals();
      try{ if(typeof updateFab==='function') updateFab(); }catch(e){}
      return;
    }

    order.forEach((it,idx)=>{
      const row=document.createElement('div');
      row.className='flex items-start justify-between gap-3';
      row.innerHTML=`
        <div class="flex-1">
          <div class="flex items-center gap-2">
            <span class="px-1.5 py-0.5 rounded bg-slate-900 text-white text-xs font-bold">${it.qty}X</span>
            <div class="font-semibold">${it.Name}</div>
          </div>
          <div class="mt-2 flex items-center gap-2">
            <button class="qty-btn" data-a="-" data-i="${idx}">‚àí</button>
            <span class="min-w-[2ch] text-center">${it.qty}</span>
            <button class="qty-btn" data-a="+" data-i="${idx}">+</button>
            <button class="ml-2 text-red-600 text-sm underline" data-a="rm" data-i="${idx}">Remove</button>
          </div>
        </div>
        <div class="text-right font-semibold">${money(it.UnitPrice*it.qty)}</div>`;
      wrap.appendChild(row);
    });

  wrap.onclick=onQtyClick;
  updateTotals();
  try{ if(typeof updateFab==='function') updateFab(); }catch(e){}
  }

  function onQtyClick(e){
    const btn=e.target.closest('[data-a]'); if(!btn) return;
    const i=+btn.dataset.i, a=btn.dataset.a;
    if(a==='+') order[i].qty+=1; else if(a==='-') order[i].qty>1?order[i].qty-=1:order.splice(i,1); else if(a==='rm') order.splice(i,1);
    drawCart();
  }

  function updateTotals(){
    if(!document.getElementById('subTotal')) return;
    const sub=subtotal();
    const d=discountAmt();
    const g=grandTotal();
    $('#subTotal').textContent=fmt(sub);
    $('#discountAmount').textContent='-'+fmt(d);
    $('#grandTotal').textContent=fmt(g);

    if(payMethod==='cash'){
      const cash=+($('#cashIn').value||0);
      const change=Math.max(0,cash-g);
      $('#change').textContent=fmt(change);
      $('#qrImg').innerHTML='';
      $('#qrSum').textContent=fmt(0)+' ‡∏ö‡∏≤‡∏ó';
    }else{
      const amt=fmt(g);
      $('#qrImg').innerHTML=`<img alt="PromptPay" class="w-48 h-48" src="https://promptpay.io/${PROMPTPAY_ID}/${amt}.png"/>`;
      $('#qrSum').textContent=`${amt} ‡∏ö‡∏≤‡∏ó`;
    }

  // Update pay button label
  $('#payBtn').textContent='Pay '+money(g);
  // Refresh floating cart button state/badge
  try{ if(typeof updateFab==='function') updateFab(); }catch(e){}
  }

  function cartCount(){ return order.reduce((s,i)=> s + Number(i.qty||0), 0); }
  function isElementInViewport(el){
    if(!el) return false;
    const r=el.getBoundingClientRect();
    const h=window.innerHeight||document.documentElement.clientHeight;
    return r.top>=0 && r.bottom<=h;
  }
  function shouldShowFab(){
    if(currentPage!=='pos') return false;            // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤ POS
    const cnt = cartCount();                         // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
    if(cnt<=0) return false;
    const isWide = window.innerWidth >= 768;         // md ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ç‡∏ß‡∏≤ ‚Üí ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏ä‡∏ß‡πå
    if(isWide) return false;
    const payBtn = document.getElementById('payBtn');
    if(!payBtn) return false;
    return !isElementInViewport(payBtn);             // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏° Pay ‚Üí ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏≠‡∏¢
  }
  function updateFab(){
    const fab   = document.getElementById('cartFab');
    const badge = document.getElementById('cartFabCount');
    if(!fab || !badge) return;
    badge.textContent = cartCount();
    fab.classList.toggle('hidden', !shouldShowFab());
  }
  window.addEventListener('scroll', updateFab, {passive:true});
  window.addEventListener('resize', updateFab);
  window.addEventListener('orientationchange', updateFab);

function makeBillId(){
  const d=new Date(); const p=n=>String(n).padStart(2,'0');
  return `PP-${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}-${p(d.getHours())}${p(d.getMinutes())}${p(d.getSeconds())}-${Math.random().toString(36).slice(2,6).toUpperCase()}`;
}
function showReceipt(s){
  // Remove existing if any
  const old=document.getElementById('receiptModal'); if(old) old.remove();
  const overlay=document.createElement('div'); overlay.id='receiptModal'; overlay.className='modal-overlay';
  const lines=(s.items||[]).map(it=>{
    const qty=Number(it.qty||0); const unit=Number(it.UnitPrice||0); const line=qty*unit;
    const name=String(it.Name||'');
    return `<tr><td class=\"text-left\">${name}</td><td class=\"text-right\">${qty}</td><td class=\"text-right\">${money(unit)}</td><td class=\"text-right\">${money(line)}</td></tr>`;
  }).join('');
  const cashRows = s.paymentMethod==='cash' ? `
    <tr><td colspan=\"3\" class=\"text-right\">‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏±‡∏ö</td><td class=\"text-right\">${fmt(s.cashIn||0)}</td></tr>
    <tr><td colspan=\"3\" class=\"text-right\">‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô</td><td class=\"text-right\">${fmt(s.change||0)}</td></tr>` : '';
  overlay.innerHTML=`
    <div class="modal p-4 receipt">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-xl font-extrabold">Pangpaan POS</div>
          <div class="text-xs text-slate-500">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞: ${s.paymentMethod==='cash'?'Cash':'PromptPay'}</div>
        </div>
        <div class="text-right text-xs">
          <div>‡∏ö‡∏¥‡∏•: <span class="font-semibold">${s.billId||''}</span></div>
          <div>${s.timestamp||''}</div>
        </div>
      </div>
      <hr class="my-3"/>
      <table>
        <thead><tr><th class="text-left">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="text-right">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th class="text-right">‡∏£‡∏ß‡∏°</th></tr></thead>
        <tbody>${lines||'<tr><td colspan="4" class="py-3 text-center text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>'}</tbody>
      </table>
      <hr class="my-3"/>
      <table>
        <tbody>
          <tr><td colspan="3" class="text-right">Subtotal</td><td class="text-right">${fmt(s.subtotal||0)}</td></tr>
          <tr><td colspan="3" class="text-right">Discount (${Number(s.discountPct||0)}%)</td><td class="text-right">-${fmt(s.discountAmount||0)}</td></tr>
          <tr><td colspan="3" class="text-right font-bold">Total</td><td class="text-right font-bold">${fmt(s.total||0)}</td></tr>
          ${cashRows}
        </tbody>
      </table>
      ${s.paymentMethod!=='cash'?`<div class="mt-2 text-center text-sm">PromptPay ‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß ${fmt(s.total||0)} ‡∏ö‡∏≤‡∏ó</div>`:''}
      <div class="flex space-x-4 mt-6 no-print">
        <button id="rcptPrint" class="w-full px-6 py-3 rounded-lg text-lg font-semibold text-white bg-green-600 border-2 border-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">‡∏û‡∏¥‡∏°‡∏û‡πå</button>
        <button id="rcptClose" class="w-full px-6 py-3 rounded-lg text-lg font-semibold text-gray-700 bg-gray-200 border-2 border-white hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  overlay.addEventListener('click',e=>{ if(e.target===overlay) overlay.remove(); });
  const close=()=> overlay.remove();
  document.getElementById('rcptClose').addEventListener('click', close);
  document.getElementById('rcptPrint').addEventListener('click', ()=>window.print());
  window.addEventListener('keydown', function esc(e){ if(e.key==='Escape'){ close(); window.removeEventListener('keydown', esc);} });
}

  // ===== Accessible Alert (large buttons for touch) =====
  function showAlert(message, opts){
    opts = opts || {}; // { title, okText, cancelText, onOk, onCancel }
    const dlg = document.getElementById('alertDialog');
    const backdrop = document.getElementById('alertBackdrop');
    const card = document.getElementById('alertCard');
    const titleEl = document.getElementById('alertTitle');
    const msgEl = document.getElementById('alertMsg');
    const okBtn = document.getElementById('alertOK');
    const cancelBtn = document.getElementById('alertCancel');

    titleEl.textContent = opts.title || '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô';
    msgEl.textContent = String(message||'');
    okBtn.textContent = opts.okText || '‡∏õ‡∏¥‡∏î';

    const hasCancel = !!opts.cancelText;
    cancelBtn.textContent = opts.cancelText || '';
    cancelBtn.classList.toggle('hidden', !hasCancel);

    const close = (cb)=>{ dlg.classList.remove('show'); document.removeEventListener('keydown', onKey); if(cb) try{ cb(); }catch{} };
    const onKey = (e)=>{ if(e.key==='Escape'){ close(opts.onCancel); } };

    okBtn.onclick = ()=> close(opts.onOk);
    cancelBtn.onclick = ()=> close(opts.onCancel);
    backdrop.onclick = ()=> close(opts.onCancel);

    dlg.classList.add('show');
    document.addEventListener('keydown', onKey, {once:true});
    // Focus for accessibility (best effort)
    setTimeout(()=>{ try{ okBtn.focus(); }catch{} }, 0);
  }

async function checkout(){
  if(!order.length) { showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', { title:'‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á', okText:'‡∏õ‡∏¥‡∏î' }); return; }
  const g = grandTotal();
  const sub = subtotal();
  const disc = discountAmt();
  const cash = (payMethod === 'cash') ? +($('#cashIn').value || 0) : 0;
  const changeAmt = (payMethod === 'cash') ? Math.max(0, cash - g) : 0;
  const billId = makeBillId();

  if (payMethod === 'cash') {
    if (cash < g) { showAlert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏°‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏≠', { title:'‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏±‡∏ö‡∏°‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠', okText:'‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß' }); return; }
  }

  // ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô localStorage ‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°
  const sales = loadSales();
  const sale = {
    billId,
    timestamp: new Date().toLocaleString('th-TH'),
    items: JSON.parse(JSON.stringify(order)),
    subtotal: sub,
    discountPct: discountPct,
    discountAmount: disc,
    total: g,
    paymentMethod: payMethod,
    cashIn: cash,
    change: changeAmt
  };
  sales.push(sale);
  saveSales(sales);

  // ‡∏¢‡∏¥‡∏á API ‚Üí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Postgres
  try{
    const resp = await fetch('/api/sales', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ 
        items: sale.items, 
        total: sale.total, 
        paymentMethod: sale.paymentMethod 
      })
    });
    if(!resp.ok){
      console.warn('API not ok', await resp.text());
    }
  }catch(e){
    console.warn('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏¢‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß)', e);
  }

  order = [];
  drawCart();
  const cashEl = $('#cashIn'); if (cashEl) cashEl.value = '0.00';
  showReceipt(sale);
}



  function setActiveNav(page){
    const nav=document.getElementById('topNav'); if(!nav) return;
    const map={ pos:'/pos', products:'/products', history:'/sale', admin:'/admin' };
    const target=map[page] || '/pos';
    nav.querySelectorAll('a').forEach(a=>{
      a.classList.remove('font-extrabold','text-green-400');
      a.classList.add('opacity-90');
      if((a.getAttribute('href')||'')===target){
        a.classList.add('font-extrabold','text-green-400');
        a.classList.remove('opacity-90');
      }
    });
  }

  function buildHistoryHTML(){
    const sales=loadSales().slice().reverse();
    if(!sales.length){ return '<div class="text-slate-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≤‡∏¢</div>'; }
    const rows=sales.map(s=>{
      const items=((s.items||[])).map(it=>`${it.qty}√ó ${it.Name}`).join(', ');
      return `<tr>
                <td class=\"py-2 pr-3 whitespace-nowrap\">${s.timestamp}</td>
                <td class=\"py-2 pr-3 whitespace-nowrap\">${s.items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td>
                <td class=\"py-2 pr-3 break-words\">${items}</td>
                <td class=\"py-2 pr-3 whitespace-nowrap\">${money(s.total)}</td>
                <td class=\"py-2 whitespace-nowrap\">${s.paymentMethod}</td>
              </tr>`;
    }).join('');
    return `<div class=\"mb-3 font-bold text-lg\">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î<\/div>
            <div class=\"overflow-auto\">
              <table class=\"min-w-full text-sm\">
                <thead class=\"text-slate-500 text-xs uppercase\"><tr>
                  <th class=\"text-left py-2 pr-3\">‡πÄ‡∏ß‡∏•‡∏≤<\/th>
                  <th class=\"text-left py-2 pr-3\">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô<\/th>
                  <th class=\"text-left py-2 pr-3\">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<\/th>
                  <th class=\"text-left py-2 pr-3\">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°<\/th>
                  <th class=\"text-left py-2\">‡∏ä‡∏≥‡∏£‡∏∞‡∏î‡πâ‡∏ß‡∏¢<\/th>
                </tr><\/thead>
                <tbody>${rows}<\/tbody>
              <\/table>
            <\/div>`;
  }

  function showPage(page){
    currentPage=page;
    const catCard=document.getElementById('catCard');
    const prodCard=document.getElementById('prodCard');
    const left=document.getElementById('leftCol');
    const existing=document.getElementById('historyBox');
    if(page==='history'){
      if(catCard) catCard.classList.add('hidden');
      if(prodCard) prodCard.classList.add('hidden');
      if(existing){ existing.innerHTML=buildHistoryHTML(); } else {
        const box=document.createElement('div');
        box.id='historyBox';
        box.className='card p-4';
        box.innerHTML=buildHistoryHTML();
        left.insertBefore(box, left.children[1] || null);
      }
    } else {
      if(catCard) catCard.classList.remove('hidden');
      if(prodCard) prodCard.classList.remove('hidden');
      if(existing) existing.remove();
    }
    setActiveNav(page);
  }

  // Router helper for path-based navigation
  function applyRoute(){
    const page=pathToPage();
    if(page!==currentPage){ currentPage=page; render(); }
    else {
      // no locLabel in header anymore
    }
  }
  window.addEventListener('popstate', applyRoute);

  // Expose addCash to global for inline onclick handlers
  window.addCash=function(v){
    if(v==='clear'){ $('#cashIn').value=''; updateTotals(); return; }
    const g=grandTotal();
    if(v==='exact'){ $('#cashIn').value=fmt(g); }
    else { $('#cashIn').value=fmt((+($('#cashIn').value||0)) + Number(v)); }
    updateTotals();
  };

  // Insert refreshProducts after loadProducts
  async function refreshProducts(){
    // re-fetch from API and keep current active category if still valid
    const prevCat = activeCat;
    await loadProducts();
    const cats = getCats();
    if(!cats.includes(prevCat)) activeCat = '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
    render();
  }

  // Basic tests (console)
  function runTests(){
    const results=[]; let fails=0;
    const log=(name,ok)=>{ if(!ok) fails++; results.push(`${ok?'‚úÖ':'‚ùå'} ${name}`); };
    // Test: function exposed
    log('addCash is global', typeof window.addCash==='function');
    // Test: addCash increments correctly and not doubled
    $('#cashIn').value=''; window.addCash(5); log('addCash +5 -> 5.00', $('#cashIn').value==='5.00');
    window.addCash(5); log('addCash +5 again -> 10.00', $('#cashIn').value==='10.00');
    // Test: clear
    window.addCash('clear'); log('addCash clear -> empty', $('#cashIn').value==='');
    // Test: exact equals grand total
    order=[{ProductCode:'TEST',Name:'Test',UnitPrice:12.34,qty:2}];
    updateTotals(); window.addCash('exact');
    log('addCash exact -> 24.68', $('#cashIn').value==='24.68');
    order=[]; updateTotals();
    // reset cash input to default after tests
    const _ci=$('#cashIn'); if(_ci){ _ci.value='0.00'; }
    console.log('[POS tests]', `fails=${fails}`, results);
  }

  // Auto-refresh products when tab becomes active
  document.addEventListener('visibilitychange', async ()=>{
    if(!document.hidden){
      await refreshProducts();
    }
  });

  // ===== Sales History (1 row per product item from API) =====
  function renderSalesHistory(){
    const left = document.getElementById('leftCol');
    if(!left) return;

    left.innerHTML = `
      <div class="card p-4 space-y-4">
        <div class="flex items-center justify-between gap-3 flex-wrap">
          <div class="text-xl font-extrabold">Sales History</div>
          <div class="flex items-end gap-2 flex-wrap">
            <div>
              <label class="text-xs block opacity-70">From</label>
              <input id="fromDate" type="date" class="border rounded px-2 py-1" />
            </div>
            <div>
              <label class="text-xs block opacity-70">To</label>
              <input id="toDate" type="date" class="border rounded px-2 py-1" />
            </div>
            <div>
              <label class="text-xs block opacity-70">Limit</label>
              <input id="limitNum" type="number" min="1" max="500" value="100" class="w-24 border rounded px-2 py-1 text-right" />
            </div>
            <button id="btnReload" class="btn btn-outline px-3 py-2">Reload</button>
            <button id="btnCSV" class="btn px-3 py-2">Export CSV</button>
          </div>
        </div>
        <div class="overflow-auto">
          <table class="w-full text-sm">
            <thead class="text-left border-b">
              <tr>
                <th class="py-2 pr-2">Time</th>
                <th class="py-2 pr-2">Bill ID</th>
                <th class="py-2 pr-2">Product</th>
                <th class="py-2 pr-2 text-right">Qty</th>
                <th class="py-2 pr-2 text-right">Unit</th>
                <th class="py-2 pr-2 text-right">Line Total</th>
                <th class="py-2 pr-2">Method</th>
              </tr>
            </thead>
            <tbody id="saleItemsBody" class="divide-y"></tbody>
          </table>
        </div>
      </div>`;

    const last = { rows: [] };

    async function load(){
      const from = document.getElementById('fromDate').value;
      const to   = document.getElementById('toDate').value;
      const lim  = +document.getElementById('limitNum').value || 100;

      // Normalize date to ISO (YYYY-MM-DD). Accepts either DD/MM/YYYY or YYYY-MM-DD.
      const normalizeDate = (s) => {
        if (!s) return '';
        const v = s.trim();
        let m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(v); // already ISO
        if (m) return v;
        m = /^(\d{2})\/(\d{2})\/(\d{4})$/.exec(v);   // DMY -> ISO
        return m ? `${m[3]}-${m[2]}-${m[1]}` : v;
      };

      const qs = new URLSearchParams();
      if (from) qs.set('from', normalizeDate(from));
      if (to)   qs.set('to',   normalizeDate(to));
      qs.set('limit', Math.min(500, Math.max(1, lim)));

      const data = await fetchJSON('/api/sales/items?' + qs.toString());
      last.rows = Array.isArray(data) ? data : [];
      renderRows(last.rows);
    }

    function renderRows(rows){
      const tb = document.getElementById('saleItemsBody');
      if(!tb) return;
      tb.innerHTML = rows.map(r=>{
        const t = new Date(r.created_at);
        const time = t.toLocaleString('th-TH', { hour12:false });
        const qty = Number(r.qty||0);
        const unit = Number(r.unit_price||0);
        const line = Number(r.line_total|| (qty*unit));
        const name = (r.name_snapshot||'').replace(/</g,'&lt;');
        return `
          <tr>
            <td class="py-2 pr-2 whitespace-nowrap">${time}</td>
            <td class="py-2 pr-2">${r.bill_id}</td>
            <td class="py-2 pr-2">${r.product_code} ‚Äî ${name}</td>
            <td class="py-2 pr-2 text-right">${qty.toFixed(3)}</td>
            <td class="py-2 pr-2 text-right">${money(unit)}</td>
            <td class="py-2 pr-2 text-right font-semibold">${money(line)}</td>
            <td class="py-2 pr-2">${r.payment_method||''}</td>
          </tr>`;
      }).join('');
    }

    function exportCSV(){
      const rows = last.rows || [];
      const head = ['timestamp','bill_id','product_code','name','qty','unit_price','line_total','payment_method'];
      const esc = v => {
        const s = String(v??'');
        return /[",\n]/.test(s) ? '"'+s.replace(/"/g,'""')+'"' : s;
      };
      const lines = [ head.join(',') ];
      for(const r of rows){
        lines.push([
          r.created_at, r.bill_id, r.product_code, r.name_snapshot,
          Number(r.qty||0), Number(r.unit_price||0).toFixed(2), Number(r.line_total||0).toFixed(2), r.payment_method
        ].map(esc).join(','));
      }
      const blob = new Blob([lines.join('\n')], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'sales-items.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    document.getElementById('btnReload').addEventListener('click', load);
    document.getElementById('btnCSV').addEventListener('click', exportCSV);

    // initial load
    load().catch(err=>{
      console.error(err);
      const tb = document.getElementById('saleItemsBody');
      if(tb) tb.innerHTML = `<tr><td class="py-3 text-red-600">Load failed: ${err.message}</td></tr>`;
    });
  }
  // boot
  (async()=>{ await loadProducts(); render(); })();
})();
</script>
  
</body>
</html>
